import*as THREE from"three";import{OrbitControls}from"three/addons/controls/OrbitControls.js";export class SceneManager3D{constructor(containerId){this.container=document.getElementById(containerId);if(!this.container){console.error(`Container ${containerId} not found`);return}this.width=this.container.clientWidth;this.height=this.container.clientHeight;this.initScene();this.initCamera();this.initRenderer();this.initLighting();this.initControls();this.worldGroup=new THREE.Group;this.scene.add(this.worldGroup);this.animate=this.animate.bind(this);this.requestAnimationFrameId=null;window.addEventListener("resize",this.onWindowResize.bind(this))}initScene(){this.scene=new THREE.Scene;this.scene.background=new THREE.Color(2105381);this.scene.fog=new THREE.Fog(2105381,20,100);this.raycaster=new THREE.Raycaster}initCamera(){this.camera=new THREE.PerspectiveCamera(45,this.width/this.height,.1,1e3);this.camera.position.set(0,40,30);this.camera.lookAt(0,0,0)}initRenderer(){this.renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});this.renderer.setSize(this.width,this.height);this.renderer.shadowMap.enabled=true;this.renderer.shadowMap.type=THREE.PCFSoftShadowMap;this.renderer.domElement.id="game-canvas-3d";this.container.appendChild(this.renderer.domElement)}initLighting(){const ambientLight=new THREE.AmbientLight(16777215,.6);this.scene.add(ambientLight);const dirLight=new THREE.DirectionalLight(16777215,.8);dirLight.position.set(20,50,20);dirLight.castShadow=true;dirLight.shadow.mapSize.width=2048;dirLight.shadow.mapSize.height=2048;dirLight.shadow.camera.near=.5;dirLight.shadow.camera.far=100;dirLight.shadow.camera.left=-50;dirLight.shadow.camera.right=50;dirLight.shadow.camera.top=50;dirLight.shadow.camera.bottom=-50;this.scene.add(dirLight);const pointLight=new THREE.PointLight(11032055,.5,50);pointLight.position.set(0,10,0);this.scene.add(pointLight)}initControls(){this.controls=new OrbitControls(this.camera,this.renderer.domElement);this.controls.enableDamping=true;this.controls.dampingFactor=.05;this.controls.screenSpacePanning=false;this.controls.minDistance=10;this.controls.maxDistance=100;this.controls.maxPolarAngle=Math.PI/2.2;this.controls.target.set(0,0,0)}onWindowResize(){if(!this.container)return;this.width=this.container.clientWidth||window.innerWidth;this.height=this.container.clientHeight||window.innerHeight;this.camera.aspect=this.width/this.height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.width,this.height)}start(){if(!this.requestAnimationFrameId){this.animate()}}stop(){if(this.requestAnimationFrameId){cancelAnimationFrame(this.requestAnimationFrameId);this.requestAnimationFrameId=null}}animate(){this.requestAnimationFrameId=requestAnimationFrame(this.animate);if(this.controls)this.controls.update();this.renderer.render(this.scene,this.camera)}initSelector(){const geometry=new THREE.CylinderGeometry(1.6,1.6,.5,6,1);const material=new THREE.MeshBasicMaterial({color:65535,transparent:true,opacity:.3,side:THREE.DoubleSide});this.selector=new THREE.Mesh(geometry,material);this.selector.visible=false;this.selector.rotation.y=Math.PI/6;const edges=new THREE.EdgesGeometry(geometry);const line=new THREE.LineSegments(edges,new THREE.LineBasicMaterial({color:65535}));this.selector.add(line);this.scene.add(this.selector)}setSelectorPosition(position){if(!this.selector)this.initSelector();this.selector.position.copy(position);this.selector.position.y+=.5;this.selector.visible=true}hideSelector(){if(this.selector)this.selector.visible=false}getIntersection(ndcX,ndcY){if(!this.raycaster||!this.camera)return null;this.raycaster.setFromCamera({x:ndcX,y:ndcY},this.camera);const intersects=this.raycaster.intersectObjects(this.worldGroup.children,true);if(intersects.length>0){for(const hit of intersects){let obj=hit.object;while(obj){if(obj.userData&&(obj.userData.type==="hex"||obj.userData.type==="unit")){return obj}if(obj===this.worldGroup)break;obj=obj.parent}}}return null}add(mesh){this.worldGroup.add(mesh)}clear(){while(this.worldGroup.children.length>0){const object=this.worldGroup.children[0];this.worldGroup.remove(object);if(object.geometry)object.geometry.dispose();if(object.material){if(Array.isArray(object.material)){object.material.forEach(mat=>mat.dispose())}else{object.material.dispose()}}}}}