import{eventBus}from"../eventBus.js";import{GAME_EVENTS}from"../constants.js";import{logger}from"../logger.js";export class ActionManager{constructor(game){this.game=game;this.history=[];this.MAX_HISTORY=20}saveCheckpoint(){logger.debug("Saving checkpoint for undo/redo");const checkpoint={hero:this.game.hero.getState(),mana:this.game.manaSource.getState(),timestamp:Date.now()};if(this.game.combat){checkpoint.combat=this.game.combat.getState();if(this.game.combatOrchestrator){checkpoint.orchestrator={attackTotal:this.game.combatOrchestrator.combatAttackTotal,blockTotal:this.game.combatOrchestrator.combatBlockTotal,activeBlocks:[...this.game.combatOrchestrator.activeBlocks],rangedTotal:this.game.combatOrchestrator.combatRangedTotal,siegeTotal:this.game.combatOrchestrator.combatSiegeTotal}}}this.history.push(checkpoint);if(this.history.length>this.MAX_HISTORY){this.history.shift()}this.updateUndoUI()}undoLastAction(){if(this.history.length===0){this.game.showToast("Nichts zum Rückgängig machen.","info");return}const checkpoint=this.history[this.history.length-1];if(this.game.combat&&!checkpoint.combat){this.game.showToast("Kann nicht über Kampf-Grenzen hinweg rückgängig machen.","error");this.clearHistory();return}this.history.pop();this.game.hero.loadState(checkpoint.hero);this.game.manaSource.loadState(checkpoint.mana);if(checkpoint.combat&&this.game.combat){this.game.combat.loadState(checkpoint.combat);if(this.game.combatOrchestrator&&checkpoint.orchestrator){const orch=this.game.combatOrchestrator;orch.combatAttackTotal=checkpoint.orchestrator.attackTotal;orch.combatBlockTotal=checkpoint.orchestrator.blockTotal;orch.activeBlocks=[...checkpoint.orchestrator.activeBlocks];orch.combatRangedTotal=checkpoint.orchestrator.rangedTotal;orch.combatSiegeTotal=checkpoint.orchestrator.siegeTotal;orch.updateCombatInfo();orch.renderUnitsInCombat()}}this.game.addLog("Aktion rückgängig gemacht.","info");logger.info("Action undone. State restored.");this.game.showToast("Rückgängig gemacht","info");this.game.render();this.game.renderHand();this.game.renderMana();this.game.updateStats();if(this.game.hero.movementPoints>0&&!this.game.combat){this.enterMovementMode()}else if(!this.game.combat){this.exitMovementMode()}this.updateUndoUI()}clearHistory(){this.history=[];this.updateUndoUI()}updateUndoUI(){const undoBtn=document.getElementById("undo-btn");if(undoBtn){undoBtn.disabled=this.history.length===0;if(this.history.length===0){undoBtn.classList.add("disabled")}else{undoBtn.classList.remove("disabled")}}}enterMovementMode(){if(this.game.gameState!=="playing"||this.game.combat)return;this.game.movementMode=true;this.calculateReachableHexes();this.game.updatePhaseIndicator()}exitMovementMode(){this.game.movementMode=false;this.game.hexGrid.clearSelection();this.game.updatePhaseIndicator()}calculateReachableHexes(){if(!this.game.hero)return;const reachable=this.game.hexGrid.getReachableHexes(this.game.hero.position,this.game.hero.movementPoints,this.game.timeManager.isDay(),this.game.hero.hasSkill("flight"));this.game.reachableHexes=reachable;this.game.hexGrid.highlightHexes(reachable)}async moveHero(q,r){if(!this.game.movementMode||this.game.gameState!=="playing")return;const distance=this.game.hexGrid.distance(this.game.hero.position.q,this.game.hero.position.r,q,r);if(distance!==1){this.game.showToast("Du kannst dich nur auf angrenzende Felder bewegen!","warning");return}const cost=this.game.hexGrid.getMovementCost(q,r,!this.game.timeManager.isDay(),this.game.hero.hasSkill("flight"));if(this.game.hero.movementPoints<cost){this.game.showToast("Nicht genug Bewegungspunkte!","warning");return}this.saveCheckpoint();const oldPos={...this.game.hero.position};this.game.hero.position={q:q,r:r};this.game.hero.movementPoints-=cost;logger.info(`Hero moved from ${oldPos.q},${oldPos.r} to ${q},${r} (Cost: ${cost}, Points left: ${this.game.hero.movementPoints})`);await this.game.animator.animateHeroMove(this.game.hero,oldPos,{q:q,r:r});this.game.hero.displayPosition={q:q,r:r};this.game.statisticsManager.increment("tilesExplored");this.game.checkAndShowAchievements();eventBus.emit(GAME_EVENTS.HERO_MOVED,{from:oldPos,to:{q:q,r:r},cost:cost});this.game.updateStats();const enemy=this.game.enemies.find(e=>!e.isDefeated()&&e.position.q===q&&e.position.r===r);if(enemy){this.clearHistory();this.game.initiateCombat(enemy);this.exitMovementMode();this.game.render();return}this.game.visitSite();if(this.game.hero.movementPoints>0&&!this.game.combat){this.calculateReachableHexes()}else{this.exitMovementMode()}this.game.render()}explore(){if(this.game.gameState!=="playing"||this.game.combat)return;const cost=this.game.timeManager.isDay()?2:3;if(this.game.hero.movementPoints<cost){this.game.showToast("Nicht genug Bewegungspunkte zum Erkunden!","warning");return}this.clearHistory();const result=this.game.mapManager.explore(this.game.hero.position.q,this.game.hero.position.r);const newHexes=this.game.hexGrid.exploreAdjacent(this.game.hero.position);if(result.success||newHexes.length>0){this.game.hero.movementPoints-=cost;const count=(result.success?7:0)+newHexes.length;this.game.addLog("Neues Gebiet entdeckt!","discovery");this.game.statisticsManager.increment("tilesExplored",count);this.game.particleSystem.discoveryEffect(this.game.hexGrid.getScreenPos(this.game.hero.position.q,this.game.hero.position.r).x,this.game.hexGrid.getScreenPos(this.game.hero.position.q,this.game.hero.position.r).y);this.game.entityManager.createEnemies();if(result.event){this.game.ui.showEventModal(result.event)}this.game.updateStats();this.game.render()}else{this.game.showToast("Hier gibt es nichts mehr zu entdecken.","info")}}playCard(index,useStrong,isNight){if(this.game.combat){this.game.playCardInCombat(index,this.game.hero.hand[index]);return}this.saveCheckpoint();const result=this.game.hero.playCard(index,useStrong,isNight);if(result){return result}else{this.history.pop();this.updateUndoUI();return null}}playCardSideways(index,effectType){if(this.game.combat)return null;this.saveCheckpoint();const result=this.game.hero.playCardSideways(index,effectType);if(result){return result}else{this.history.pop();this.updateUndoUI();return null}}takeMana(index,_color){this.saveCheckpoint();const mana=this.game.manaSource.takeDie(index,this.game.timeManager.isNight());if(mana){this.game.hero.takeManaFromSource(mana);return mana}else{this.history.pop();this.updateUndoUI();return null}}visitSite(){if(this.game.combat)return;const currentHex=this.game.hexGrid.getHex(this.game.hero.position.q,this.game.hero.position.r);if(!currentHex||!currentHex.site)return;const site=currentHex.site;this.game.addLog(`Besuche ${site.getName()}...`,"info");const interactionData=this.game.siteManager.visitSite(currentHex,site);this.game.ui.showSiteModal(interactionData)}}