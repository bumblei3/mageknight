import{TERRAIN_TYPES}from"./constants.js";import{SITE_TYPES,Site}from"./sites.js";export class MapManager{constructor(hexGrid){this.hexGrid=hexGrid;this.tilesDeck=[];this.initializeDeck();this.revealedHexes=new Set;this.worldEvents=null}setWorldEventManager(manager){this.worldEvents=manager}initializeDeck(){this.tilesDeck=[[TERRAIN_TYPES.PLAINS,TERRAIN_TYPES.FOREST,TERRAIN_TYPES.HILLS,TERRAIN_TYPES.PLAINS,TERRAIN_TYPES.FOREST,TERRAIN_TYPES.DESERT,TERRAIN_TYPES.WATER],[TERRAIN_TYPES.FOREST,TERRAIN_TYPES.PLAINS,TERRAIN_TYPES.PLAINS,TERRAIN_TYPES.HILLS,TERRAIN_TYPES.FOREST,TERRAIN_TYPES.HILLS,TERRAIN_TYPES.PLAINS],[TERRAIN_TYPES.HILLS,TERRAIN_TYPES.DESERT,TERRAIN_TYPES.WASTELAND,TERRAIN_TYPES.HILLS,TERRAIN_TYPES.PLAINS,TERRAIN_TYPES.FOREST,TERRAIN_TYPES.PLAINS],[TERRAIN_TYPES.PLAINS,TERRAIN_TYPES.WATER,TERRAIN_TYPES.PLAINS,TERRAIN_TYPES.FOREST,TERRAIN_TYPES.HILLS,TERRAIN_TYPES.DESERT,TERRAIN_TYPES.PLAINS],[TERRAIN_TYPES.DESERT,TERRAIN_TYPES.WASTELAND,TERRAIN_TYPES.MOUNTAINS,TERRAIN_TYPES.HILLS,TERRAIN_TYPES.DESERT,TERRAIN_TYPES.PLAINS,TERRAIN_TYPES.FOREST],[TERRAIN_TYPES.WASTELAND,TERRAIN_TYPES.MOUNTAINS,TERRAIN_TYPES.MOUNTAINS,TERRAIN_TYPES.WASTELAND,TERRAIN_TYPES.DESERT,TERRAIN_TYPES.HILLS,TERRAIN_TYPES.FOREST]]}createStartingMap(scenario=null){let centerTile=[TERRAIN_TYPES.PLAINS,TERRAIN_TYPES.FOREST,TERRAIN_TYPES.HILLS,TERRAIN_TYPES.PLAINS,TERRAIN_TYPES.FOREST,TERRAIN_TYPES.DESERT,TERRAIN_TYPES.WATER];if(scenario&&scenario.mapConfig&&scenario.mapConfig.startTile){centerTile=scenario.mapConfig.startTile}if(scenario&&scenario.mapConfig&&scenario.mapConfig.deck){this.tilesDeck=[...scenario.mapConfig.deck]}else{this.initializeDeck()}this.placeTile(0,0,centerTile);this.placeTile(3,0,[TERRAIN_TYPES.FOREST,TERRAIN_TYPES.HILLS,TERRAIN_TYPES.WASTELAND,TERRAIN_TYPES.FOREST,TERRAIN_TYPES.PLAINS,TERRAIN_TYPES.HILLS,TERRAIN_TYPES.FOREST]);this.placeTile(0,3,[TERRAIN_TYPES.HILLS,TERRAIN_TYPES.FOREST,TERRAIN_TYPES.PLAINS,TERRAIN_TYPES.HILLS,TERRAIN_TYPES.FOREST,TERRAIN_TYPES.HILLS,TERRAIN_TYPES.DESERT]);this.placeTile(-3,0,[TERRAIN_TYPES.DESERT,TERRAIN_TYPES.PLAINS,TERRAIN_TYPES.FOREST,TERRAIN_TYPES.HILLS,TERRAIN_TYPES.MOUNTAINS,TERRAIN_TYPES.FOREST,TERRAIN_TYPES.PLAINS]);this.revealMap(0,0,4)}canExplore(q,r){const neighbors=this.hexGrid.getNeighbors(q,r);return neighbors.some(n=>!this.hexGrid.hasHex(n.q,n.r))}explore(fromQ,fromR){if(this.tilesDeck.length===0){return{success:false,message:"Keine weiteren Gebiete zu erkunden."}}const neighbors=this.hexGrid.getNeighbors(fromQ,fromR);const emptyNeighbors=neighbors.filter(n=>!this.hexGrid.hasHex(n.q,n.r));if(emptyNeighbors.length===0){return{success:false,message:"Kein Platz zum Erkunden."}}emptyNeighbors.sort((a,b)=>{const distA=this.hexGrid.distance(0,0,a.q,a.r);const distB=this.hexGrid.distance(0,0,b.q,b.r);return distB-distA});const targetCenter=emptyNeighbors[0];const tileTerrains=this.tilesDeck.shift();this.placeTile(targetCenter.q,targetCenter.r,tileTerrains);let event=null;if(this.worldEvents){event=this.worldEvents.checkForEvent(tileTerrains[0])}return{success:true,message:"Neues Gebiet entdeckt!",center:targetCenter,event:event}}placeTile(centerQ,centerR,terrains){this.hexGrid.setHex(centerQ,centerR,{terrain:terrains[0],revealed:false});const neighbors=this.hexGrid.getNeighbors(centerQ,centerR);neighbors.forEach((n,i)=>{if(!this.hexGrid.hasHex(n.q,n.r)){const terrain=terrains[i+1]||TERRAIN_TYPES.PLAINS;const hexData={terrain:terrain,revealed:false};if(Math.random()<.2){const siteType=this.getRandomSiteForTerrain(terrain);if(siteType){hexData.site=new Site(siteType)}}this.hexGrid.setHex(n.q,n.r,hexData)}})}getRandomSiteForTerrain(terrain){switch(terrain){case TERRAIN_TYPES.PLAINS:return Math.random()<.7?SITE_TYPES.VILLAGE:null;case TERRAIN_TYPES.HILLS:{const roll=Math.random();if(roll<.3)return SITE_TYPES.KEEP;if(roll<.6)return SITE_TYPES.MONASTERY;if(roll<.8)return SITE_TYPES.MINE;return null}case TERRAIN_TYPES.FOREST:{const roll=Math.random();if(roll<.2)return SITE_TYPES.SPAWNING_GROUNDS;if(roll<.4)return SITE_TYPES.KEEP;return null}case TERRAIN_TYPES.WASTELAND:{const wRoll=Math.random();if(wRoll<.2)return SITE_TYPES.LABYRINTH;if(wRoll<.4)return SITE_TYPES.MAGE_TOWER;if(wRoll<.6)return SITE_TYPES.TOMB;if(wRoll<.8)return SITE_TYPES.DUNGEON;return SITE_TYPES.RUIN}case TERRAIN_TYPES.DESERT:{const dRoll=Math.random();if(dRoll<.3)return SITE_TYPES.LABYRINTH;if(dRoll<.6)return SITE_TYPES.MAGE_TOWER;return null}case TERRAIN_TYPES.MOUNTAINS:return Math.random()<.7?SITE_TYPES.MINE:SITE_TYPES.DUNGEON;case TERRAIN_TYPES.WATER:return null;default:return null}}revealMap(q,r,range=2){const hexes=this.hexGrid.getHexesInRange(q,r,range);let newReveals=0;hexes.forEach(hex=>{if(this.hexGrid.hasHex(hex.q,hex.r)){const hexData=this.hexGrid.getHex(hex.q,hex.r);if(!hexData.revealed){this.hexGrid.setHex(hex.q,hex.r,{...hexData,revealed:true});this.revealedHexes.add(`${hex.q},${hex.r}`);newReveals++}}});return newReveals}}