import{eventBus}from"./eventBus.js";import{GAME_EVENTS}from"./constants.js";export class StatisticsManager{constructor(){this.stats=this.createDefaultStats();this.load();this._setupEventListeners()}_setupEventListeners(){eventBus.on(GAME_EVENTS.HERO_MOVED,data=>{this.trackMovement(data.cost||1)});eventBus.on(GAME_EVENTS.COMBAT_ENDED,data=>{if(data.victory&&data.enemy){this.trackEnemyDefeated(data.enemy)}this.trackCombat(data.victory,0)});eventBus.on(GAME_EVENTS.COMBAT_STARTED,()=>{this.increment("combatsStarted")})}createDefaultStats(){return{gamesPlayed:0,gamesWon:0,gamesLost:0,totalPlayTime:0,turns:0,level:1,fame:0,reputation:0,enemiesDefeated:0,dragonsDefeated:0,perfectCombats:0,totalDamageDealt:0,totalDamageTaken:0,combatsWon:0,combatsLost:0,combatsStarted:0,cardsPlayed:0,attackCardsPlayed:0,blockCardsPlayed:0,movementCardsPlayed:0,influenceCardsPlayed:0,totalCards:0,manaUsed:0,manaByColor:{red:0,blue:0,white:0,green:0,gold:0,black:0},tilesExplored:0,sitesVisited:0,hexesMoved:0,totalMovement:0,victory:false,closeCallSurvival:0,wounds:0,healed:0,restsUsed:0}}increment(statName,amount=1){if(Object.hasOwn(this.stats,statName)){this.stats[statName]+=amount;this.save()}}set(statName,value){if(Object.hasOwn(this.stats,statName)){this.stats[statName]=value;this.save()}}get(statName){return this.stats[statName]}getAll(){return{...this.stats}}trackCardPlayed(card){this.increment("cardsPlayed");if(card.color){const colorMap={red:"attackCardsPlayed",blue:"blockCardsPlayed",green:"movementCardsPlayed",white:"influenceCardsPlayed"};const statName=colorMap[card.color];if(statName){this.increment(statName)}}}trackEnemyDefeated(enemy){this.increment("enemiesDefeated");if(enemy.type==="dragon"){this.increment("dragonsDefeated")}}trackCombat(won,woundsTaken){if(won){this.increment("combatsWon");if(woundsTaken===0){this.increment("perfectCombats")}}else{this.increment("combatsLost")}}trackManaUsed(color){this.increment("manaUsed");if(Object.hasOwn(this.stats.manaByColor,color)){this.stats.manaByColor[color]++;this.save()}}trackExploration(){this.increment("tilesExplored")}trackSiteVisit(){this.increment("sitesVisited")}trackMovement(distance){this.increment("hexesMoved");this.increment("totalMovement",distance)}trackTurn(){this.increment("turns")}trackLevelUp(newLevel){this.set("level",newLevel)}startGame(){const globalStats={gamesPlayed:this.stats.gamesPlayed,gamesWon:this.stats.gamesWon,gamesLost:this.stats.gamesLost,totalPlayTime:this.stats.totalPlayTime};this.stats=this.createDefaultStats();Object.assign(this.stats,globalStats);this.increment("gamesPlayed");this.save()}endGame(victory){this.set("victory",victory);if(victory){this.increment("gamesWon")}else{this.increment("gamesLost")}this.save()}getSummary(){return{winRate:this.getWinRate(),averageTurns:this.getAverageTurns(),favoriteColor:this.getFavoriteColor(),combatSuccessRate:this.getCombatSuccessRate(),explorationProgress:this.stats.tilesExplored,achievementProgress:0}}getWinRate(){const total=this.stats.gamesWon+this.stats.gamesLost;if(total===0)return 0;return Math.round(this.stats.gamesWon/total*100)}getAverageTurns(){if(this.stats.gamesPlayed===0)return 0;return Math.round(this.stats.turns/this.stats.gamesPlayed)}getFavoriteColor(){let maxColor="none";let maxCount=0;Object.entries(this.stats.manaByColor).forEach(([color,count])=>{if(count>maxCount){maxCount=count;maxColor=color}});return maxColor}getCombatSuccessRate(){const total=this.stats.combatsWon+this.stats.combatsLost;if(total===0)return 0;return Math.round(this.stats.combatsWon/total*100)}save(){try{const data={stats:this.stats,timestamp:Date.now()};localStorage.setItem("mageKnight_statistics",JSON.stringify(data))}catch(error){console.error("Failed to save statistics:",error)}}load(){try{const data=localStorage.getItem("mageKnight_statistics");if(data&&data.startsWith("{")){const parsed=JSON.parse(data);if(parsed&&typeof parsed==="object"&&parsed.stats){this.stats={...this.createDefaultStats(),...parsed.stats}}}}catch(error){console.error("Failed to load statistics:",error)}if(!this.stats||typeof this.stats!=="object"){this.stats=this.createDefaultStats()}}reset(){this.stats=this.createDefaultStats();this.save()}export(){return JSON.stringify(this.stats,null,2)}getState(){return{...this.stats}}loadState(state){if(!state)return;this.stats={...this.createDefaultStats(),...state}}}export default StatisticsManager;