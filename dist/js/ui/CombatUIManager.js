import{COMBAT_PHASES,ACTION_TYPES}from"../constants.js";export class CombatUIManager{constructor(elements,ui){this.elements=elements;this.ui=ui}showCombatPanel(enemies,phase,onEnemyClick){if(this.elements.combatPanel){this.elements.combatPanel.style.display="flex";this.elements.combatPanel.classList.add("active-combat");this.updateCombatInfo(enemies,phase,onEnemyClick)}}hideCombatPanel(){if(this.elements.combatPanel){this.elements.combatPanel.style.display="none";this.elements.combatPanel.classList.remove("active-combat")}if(this.elements.combatInfo)this.elements.combatInfo.innerHTML="";if(this.elements.combatUnits)this.elements.combatUnits.innerHTML=""}reset(){this.hideCombatPanel()}updateCombatInfo(enemies,phase,onEnemyClick){const info=this.elements.combatInfo;if(!info)return;const phaseLabel=this.getCombatPhaseName(phase);const colorClass=phase===COMBAT_PHASES.ATTACK?"attack-phase":phase===COMBAT_PHASES.RANGED?"ranged-phase":"block-phase";info.innerHTML=`\n            <div class="combat-status ${colorClass}">\n                <strong>${phaseLabel}</strong>\n                <small>${this.getPhaseHint(phase)}</small>\n            </div>\n        `;enemies.forEach(enemy=>{const enemyDiv=this.renderEnemy(enemy,phase,onEnemyClick);info.appendChild(enemyDiv)})}updateCombatTotals(attackTotal,blockTotal,phase){const info=this.elements.combatInfo;if(!info)return;let totalsDiv=document.getElementById("combat-totals");if(!totalsDiv){totalsDiv=document.createElement("div");totalsDiv.id="combat-totals";info.insertBefore(totalsDiv,info.firstChild)}let html='<div class="combat-totals-row">';if(phase===COMBAT_PHASES.BLOCK){html+=`<div class="total-stat block-stat">\n                <div class="total-label">Total Block</div>\n                <div class="total-value">${blockTotal}</div>\n            </div>`}else if(phase===COMBAT_PHASES.ATTACK){html+=`<div class="total-stat attack-stat">\n                <div class="total-label">Total Attack</div>\n                <div class="total-value">${attackTotal}</div>\n            </div>`}else if(phase===COMBAT_PHASES.RANGED){const orchestrator=this.ui?.game?.combatOrchestrator;const rangedTotal=orchestrator?.combatRangedTotal??attackTotal;const siegeTotal=orchestrator?.combatSiegeTotal??0;html+=`\n                <div class="total-stat ranged-stat">\n                    <div class="total-label">Fernkampf</div>\n                    <div class="total-value">${rangedTotal}</div>\n                </div>\n                <div class="total-stat siege-stat">\n                    <div class="total-label">Belagerung</div>\n                    <div class="total-value">${siegeTotal}</div>\n                </div>\n            `}html+="</div>";const prediction=this.ui?.game?.combat?.getPredictedOutcome(attackTotal,blockTotal);if(prediction){html+=`\n                <div class="combat-prediction">\n                    <div class="prediction-details">\n                        ${prediction.expectedWounds>0?`<div class="prediction-danger">\n                                üíî <span><strong>${prediction.expectedWounds}</strong> Wunden erwartet</span>\n                                ${prediction.isPoisoned?'<span class="poison-warning">+ GIFT!</span>':""}\n                             </div>`:'<div class="prediction-safe">‚úÖ Kein Schaden erwartet</div>'}\n                        ${prediction.enemiesDefeated.length>0?`<div class="prediction-success">\n                                ‚öîÔ∏è <strong>Besiegbar:</strong> ${prediction.enemiesDefeated.join(", ")}\n                             </div>`:""}\n                    </div>\n                </div>\n            `}totalsDiv.innerHTML=html;const executeAttackBtn=document.getElementById("execute-attack-btn");if(executeAttackBtn){if(phase===COMBAT_PHASES.RANGED){executeAttackBtn.textContent="Fernkampf beenden -> Blocken";executeAttackBtn.style.display="block"}else if(phase===COMBAT_PHASES.BLOCK){executeAttackBtn.textContent="Blocken beenden -> Schaden";executeAttackBtn.style.display="block"}else if(phase===COMBAT_PHASES.DAMAGE){executeAttackBtn.textContent="Schaden akzeptieren (Rest auf Held)";executeAttackBtn.style.display="block";executeAttackBtn.classList.add("damage-phase-btn")}else if(phase===COMBAT_PHASES.ATTACK){executeAttackBtn.textContent="Angriff ausf√ºhren";executeAttackBtn.style.display="block";executeAttackBtn.classList.remove("damage-phase-btn")}else{executeAttackBtn.style.display="none"}}}getCombatPhaseName(phase){const names={[COMBAT_PHASES.NOT_IN_COMBAT]:"Kein Kampf",[COMBAT_PHASES.RANGED]:"Fernkampf-Phase",[COMBAT_PHASES.BLOCK]:"Block-Phase",[COMBAT_PHASES.DAMAGE]:"Schadens-Phase",[COMBAT_PHASES.ATTACK]:"Angriffs-Phase",[COMBAT_PHASES.COMPLETE]:"Abgeschlossen"};return names[phase]||phase}getPhaseHint(phase){const hints={[COMBAT_PHASES.RANGED]:"Besiege Feinde mit Fernkampf- oder Belagerungswerten. Befestigte Feinde (üè∞) ignorieren normalen Fernkampf!",[COMBAT_PHASES.BLOCK]:"Blocke Feind-Angriffe. Ungeblockte Feinde verursachen Schaden.",[COMBAT_PHASES.ATTACK]:"Besiege verbliebene Feinde mit normalen Angriffswerten."};return hints[phase]||""}renderEnemy(enemy,phase,onClick){const el=document.createElement("div");el.className="enemy-card";const combat=this.game?.combat;const isBlocked=combat?.blockedEnemies?.has(enemy.id)||false;if(isBlocked){el.classList.add("blocked-enemy");el.style.opacity="0.6"}if(enemy.isBoss){el.classList.add("boss-card")}if((phase===COMBAT_PHASES.RANGED||phase===COMBAT_PHASES.BLOCK)&&onClick&&!isBlocked){el.style.cursor="crosshair";el.title=phase===COMBAT_PHASES.RANGED?"Klicken f√ºr Fernkampf-Angriff":"Klicken zum Blocken";el.addEventListener("click",()=>onClick(enemy));el.addEventListener("mouseenter",()=>el.style.boxShadow=phase===COMBAT_PHASES.RANGED?"0 0 10px red":"0 0 10px #3b82f6");el.addEventListener("mouseleave",()=>el.style.boxShadow=enemy.isBoss?"0 0 8px rgba(251, 191, 36, 0.5)":"none")}const attackValue=typeof enemy.getEffectiveAttack==="function"?enemy.getEffectiveAttack():enemy.attack;const attackType=enemy.attackType||"physical";const blockReq=typeof enemy.getBlockRequirement==="function"?enemy.getBlockRequirement():attackValue;const typeIcons={physical:"‚öîÔ∏è",fire:"üî•",ice:"‚ùÑÔ∏è",cold_fire:"üî•‚ùÑÔ∏è"};const typeIcon=typeIcons[attackType]||"‚öîÔ∏è";let bossHealthHTML="";if(enemy.isBoss){const healthPercent=(typeof enemy.getHealthPercent==="function"?enemy.getHealthPercent():1)*100;const healthColor=healthPercent>60?"#10b981":healthPercent>30?"#fbbf24":"#ef4444";const phaseName=typeof enemy.getPhaseName==="function"?enemy.getPhaseName():"Boss";bossHealthHTML=`\n                <div class="boss-health-section">\n                    <div class="boss-health-info">\n                        <span class="boss-phase-name">üëø ${phaseName}</span>\n                        <span class="boss-hp-value" style="color: ${healthColor}">${enemy.currentHealth}/${enemy.maxHealth} HP</span>\n                    </div>\n                    <div class="boss-health-bar">\n                        <div class="boss-health-fill" style="width: ${healthPercent}%; background: linear-gradient(90deg, ${healthColor}, ${healthColor}aa);"></div>\n                    </div>\n                    ${enemy.enraged?'<div class="boss-enraged-label">üî• W√úTEND!</div>':""}\n                </div>\n            `}const blockBadge=phase===COMBAT_PHASES.BLOCK&&!isBlocked?`<div class="block-badge">Ben√∂tigt: ${blockReq}</div>`:"";el.innerHTML=`\n            <div class="enemy-icon" style="color: ${enemy.color}">\n                ${isBlocked?"üõ°Ô∏è":enemy.icon}\n            </div>\n            <div class="enemy-details">\n                <div class="enemy-name">\n                    ${isBlocked?'<span class="blocked-label">[GEBLOCKT]</span><br>':""}\n                    ${enemy.name}\n                </div>\n                <div class="enemy-stats">\n                    <div class="stat" title="R√ºstung">üõ°Ô∏è ${enemy.armor}</div>\n                    <div class="stat" title="Angriff">\n                        <span class="ability-icon" data-tooltip-type="ability" data-tooltip-key="${attackType}">${typeIcon}</span> <span>${attackValue}</span>\n                    </div>\n                </div>\n                ${bossHealthHTML}\n                <div class="enemy-traits">\n                    ${enemy.fortified?'<span class="ability-icon" data-tooltip-type="ability" data-tooltip-key="fortified">üè∞</span>':""}\n                    ${enemy.swift?'<span class="ability-icon" data-tooltip-type="ability" data-tooltip-key="swift">üí®</span>':""}\n                    ${enemy.poison?'<span class="ability-icon" data-tooltip-type="ability" data-tooltip-key="poison">ü§¢</span>':""}\n                    ${enemy.vampiric?'<span class="ability-icon" data-tooltip-type="ability" data-tooltip-key="vampiric">üßõ</span>':""}\n                    ${enemy.brutal?'<span class="ability-icon" data-tooltip-type="ability" data-tooltip-key="brutal">üëπ</span>':""}\n                    ${enemy.paralyze?'<span class="ability-icon" data-tooltip-type="ability" data-tooltip-key="paralyze">‚ö°</span>':""}\n                    ${enemy.cumbersome?'<span class="ability-icon" data-tooltip-type="ability" data-tooltip-key="cumbersome">üèãÔ∏è</span>':""}\n                    ${enemy.assassin?'<span class="ability-icon" data-tooltip-type="ability" data-tooltip-key="assassin">üó°Ô∏è</span>':""}\n                    ${enemy.summoner?'<span class="ability-icon" data-tooltip-type="ability" data-tooltip-key="summoner">ü¶á</span>':""}\n                    ${enemy.elusive?'<span class="ability-icon" data-tooltip-type="ability" data-tooltip-key="elusive">üë§</span>':""}\n                    ${enemy.isBoss?'<span class="ability-icon" data-tooltip-type="ability" data-tooltip-key="boss">üëë</span>':""}\n                </div>\n            </div>\n            ${blockBadge}\n        `;if(this.ui&&this.ui.tooltipManager){const abilityIcons=el.querySelectorAll(".ability-icon");abilityIcons.forEach(icon=>{this.ui.tooltipManager.attachToElement(icon)})}return el}renderUnitsInCombat(units,phase,onUnitActivate){const container=this.elements.combatUnits;if(!container)return;container.innerHTML="";if(!units||units.length===0)return;const title=document.createElement("h3");title.textContent="üéñÔ∏è Deine Einheiten";container.appendChild(title);if(phase===COMBAT_PHASES.DAMAGE){const hint=document.createElement("div");hint.className="damage-assignment-hint";hint.innerHTML="<small>Klicke auf eine Einheit, um Schaden zuzuweisen (Sch√ºtzt den Helden).</small>";hint.style.color="#ef4444";hint.style.marginBottom="10px";container.appendChild(hint)}const grid=document.createElement("div");grid.className="combat-units-grid";units.forEach(unit=>{const isReady=typeof unit.isReady==="function"?unit.isReady():true;let canAct=false;let actionText="";if(phase===COMBAT_PHASES.BLOCK){const abilities=(typeof unit.getAbilities==="function"?unit.getAbilities():[]).filter(a=>a.type===ACTION_TYPES.BLOCK);canAct=isReady&&abilities.length>0;actionText=abilities.map(a=>a.text).join(", ")}else if(phase===COMBAT_PHASES.ATTACK){const abilities=(typeof unit.getAbilities==="function"?unit.getAbilities():[]).filter(a=>a.type===ACTION_TYPES.ATTACK);canAct=isReady&&abilities.length>0;actionText=abilities.map(a=>a.text).join(", ")}else if(phase===COMBAT_PHASES.RANGED){const abilities=(typeof unit.getAbilities==="function"?unit.getAbilities():[]).filter(a=>a.type===ACTION_TYPES.RANGED||a.type===ACTION_TYPES.SIEGE);canAct=isReady&&abilities.length>0;actionText=abilities.map(a=>a.text).join(", ")}else if(phase===COMBAT_PHASES.DAMAGE){canAct=isReady;actionText="Schaden nehmen (-1 Wunde)"}const unitCard=document.createElement("div");const extraClass=phase===COMBAT_PHASES.DAMAGE&&canAct?"damage-target":"";unitCard.className=`unit-combat-card ${canAct?"":"not-ready"} ${extraClass}`;if(!actionText&&canAct&&phase!==COMBAT_PHASES.DAMAGE){actionText="Aktion verf√ºgbar"}else if(!actionText){actionText="Keine Aktion"}unitCard.innerHTML=`\n                <div style="display: flex; align-items: center; justify-content: space-between;">\n                    <div>\n                        <span style="font-size: 1.2rem;">${unit.getIcon()}</span>\n                        <strong>${unit.getName()}</strong>\n                    </div>\n                    <div style="font-size: 0.85rem; color: ${canAct?"#10b981":"#6b7280"};">\n                        ${actionText}\n                    </div>\n                </div>\n            `;if(phase===COMBAT_PHASES.DAMAGE&&canAct){unitCard.style.borderColor="#ef4444";unitCard.querySelector("strong").style.color="#ef4444"}if(canAct&&onUnitActivate){unitCard.addEventListener("click",()=>{onUnitActivate(unit)});const hoverColor=phase===COMBAT_PHASES.DAMAGE?"rgba(239, 68, 68, 0.2)":"rgba(139, 92, 246, 0.2)";const hoverBorder=phase===COMBAT_PHASES.DAMAGE?"rgba(239, 68, 68, 0.6)":"rgba(139, 92, 246, 0.6)";unitCard.addEventListener("mouseenter",()=>{unitCard.style.background=hoverColor;unitCard.style.borderColor=hoverBorder});unitCard.addEventListener("mouseleave",()=>{unitCard.style.background=phase===COMBAT_PHASES.DAMAGE?"none":"rgba(139, 92, 246, 0.1)";unitCard.style.borderColor=phase===COMBAT_PHASES.DAMAGE?"#ef4444":"rgba(139, 92, 246, 0.3)"})}grid.appendChild(unitCard)});container.appendChild(grid)}}